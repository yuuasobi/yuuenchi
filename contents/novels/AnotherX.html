<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnotherX - 図書館</title>
    <link rel="icon" type="image/png" href="../../source/観覧車ファビコン.png">
    <link rel="shortcut icon" type="image/png" href="../../source/観覧車ファビコン.png">
    <link rel="apple-touch-icon" href="../../source/観覧車ファビコン.png">
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="anotherx-style.css">
</head>
<body>
    <script src="../../header.js"></script>
    
    <header class="library-header">
        <h1>📚 AnotherX 📚</h1>
    </header>
    
    <div class="container">
        <div class="library-content">
            <div class="bookshelf">
                <h2>第1章</h2>
                <div class="episodes-list">
                    <div class="episode-card" data-episode="1" data-title="旅路">
                        <div class="episode-number">Episode 1</div>
                        <h3>旅路</h3>
                    </div>
                    <div class="episode-card" data-episode="2" data-title="森での戦い">
                        <div class="episode-number">Episode 2</div>
                        <h3>森での戦い</h3>
                    </div>
                    <div class="episode-card" data-episode="3" data-title="ピンク髪の女の子">
                        <div class="episode-number">Episode 3</div>
                        <h3>ピンク髪の女の子</h3>
                    </div>
                    <div class="episode-card" data-episode="4" data-title="モネ">
                        <div class="episode-number">Episode 4</div>
                        <h3>モネ</h3>
                    </div>
                    <div class="episode-card" data-episode="5" data-title="渓谷のかくれんぼ">
                        <div class="episode-number">Episode 5</div>
                        <h3>渓谷のかくれんぼ</h3>
                    </div>
                    <div class="episode-card" data-episode="6" data-title="モリの村">
                        <div class="episode-number">Episode 6</div>
                        <h3>モリの村</h3>
                    </div>
                    <div class="episode-card" data-episode="6.5" data-title="寝顔">
                        <div class="episode-number">Episode 6.5</div>
                        <h3>寝顔</h3>
                    </div>
                    <div class="episode-card" data-episode="7" data-title="遺跡に巣食うもの">
                        <div class="episode-number">Episode 7</div>
                        <h3>遺跡に巣食うもの</h3>
                    </div>
                    <div class="episode-card" data-episode="8" data-title="洞窟に潜むもの">
                        <div class="episode-number">Episode 8</div>
                        <h3>洞窟に潜むもの</h3>
                    </div>
                    <div class="episode-card" data-episode="9" data-title="薬学の心得">
                        <div class="episode-number">Episode 9</div>
                        <h3>薬学の心得</h3>
                    </div>
                    <div class="episode-card" data-episode="10" data-title="ゲリラホーク戦">
                        <div class="episode-number">Episode 10</div>
                        <h3>ゲリラホーク戦</h3>
                    </div>
                    <div class="episode-card" data-episode="11" data-title="怪鳥と異変">
                        <div class="episode-number">Episode 11</div>
                        <h3>怪鳥と異変</h3>
                    </div>
                    <div class="episode-card" data-episode="12" data-title="ノンの作戦">
                        <div class="episode-number">Episode 12</div>
                        <h3>ノンの作戦</h3>
                    </div>
                    <div class="episode-card" data-episode="13" data-title="エーテル">
                        <div class="episode-number">Episode 13</div>
                        <h3>エーテル</h3>
                    </div>
                </div>
            </div>
            <div class="content-panel">
                <div class="no-content">
                    <img src="../../source/AnotherX/アナザークロス_サムネイル.png" alt="AnotherX サムネイル" class="thumbnail-image">
                    <p class="novel-description">AnotherXは長編ファンタジーのテロップ形式で読む小説です</p>
                    <h2>📖 左のリストからエピソードを選択してください</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="external-links-section">
        <div class="container">
            <h3>📖 すべてのエピソードの公開サイト</h3>
            <div class="link-container">
                <a href="https://note.com/yuuenchi/n/n8f222e18e395" target="_blank" class="external-link">
                    <span class="link-icon">🇯🇵</span>
                    <span class="link-text">日本語版（note）</span>
                </a>
                <a href="https://medium.com/fantasy-novel-anotherx/fantasy-novel-anotherx-f95eb90925bb" target="_blank" class="external-link">
                    <span class="link-icon">🇺🇸</span>
                    <span class="link-text">英語版（Medium）</span>
                </a>
            </div>
        </div>
    </div>

    <div class="world-map-section">
        <div class="container">
            <h3>🗺️ World Map Miruze</h3>
            <p class="world-map-description">illustration by kuroro</p>
            <div class="world-map-container">
                <img src="../../source/AnotherX/miruze_map.jpg" alt="World Map Miruze" class="world-map-image">
            </div>
        </div>
    </div>

    <div class="gallery-section">
        <div class="container">
            <h3>🖼️ Kuroro Gallery</h3>
            <div class="gallery-grid">
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_01_焚火_AnotherX_くろろ.jpg', '焚火')">
                    <img src="../../source/AnotherX/Gallery/01_01_焚火_AnotherX_くろろ.jpg" alt="焚火" loading="lazy">
                    <div class="gallery-caption">焚火</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_02_きのこ_AnotherX_くろろ.jpg', 'きのこ')">
                    <img src="../../source/AnotherX/Gallery/01_02_きのこ_AnotherX_くろろ.jpg" alt="きのこ" loading="lazy">
                    <div class="gallery-caption">きのこ</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_02_ゴブリン_AnotherX_くろろ.jpg', 'ゴブリン')">
                    <img src="../../source/AnotherX/Gallery/01_02_ゴブリン_AnotherX_くろろ.jpg" alt="ゴブリン" loading="lazy">
                    <div class="gallery-caption">ゴブリン</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_03_ノン_AnotherX_くろろ.jpg', 'ノン')">
                    <img src="../../source/AnotherX/Gallery/01_03_ノン_AnotherX_くろろ.jpg" alt="ノン" loading="lazy">
                    <div class="gallery-caption">ノン</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_04_鍋_AnotherX_くろろ.jpg', '鍋')">
                    <img src="../../source/AnotherX/Gallery/01_04_鍋_AnotherX_くろろ.jpg" alt="鍋" loading="lazy">
                    <div class="gallery-caption">鍋</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_04_料理_AnotherX_くろろ.jpg', '料理')">
                    <img src="../../source/AnotherX/Gallery/01_04_料理_AnotherX_くろろ.jpg" alt="料理" loading="lazy">
                    <div class="gallery-caption">料理</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_05_モネ白_AnotherX_くろろ.jpg', 'モネ（白）')">
                    <img src="../../source/AnotherX/Gallery/01_05_モネ白_AnotherX_くろろ.jpg" alt="モネ（白）" loading="lazy">
                    <div class="gallery-caption">モネ（白）</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_05_モネ黒_AnotherX_くろろ.jpg', 'モネ（黒）')">
                    <img src="../../source/AnotherX/Gallery/01_05_モネ黒_AnotherX_くろろ.jpg" alt="モネ（黒）" loading="lazy">
                    <div class="gallery-caption">モネ（黒）</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_10_ゲリラホーク_AnotherX_くろろ.jpg', 'ゲリラホーク')">
                    <img src="../../source/AnotherX/Gallery/01_10_ゲリラホーク_AnotherX_くろろ.jpg" alt="ゲリラホーク" loading="lazy">
                    <div class="gallery-caption">ゲリラホーク</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_10_ゲリラホーク戦_AnotherX_くろろ.jpg', 'ゲリラホーク戦')">
                    <img src="../../source/AnotherX/Gallery/01_10_ゲリラホーク戦_AnotherX_くろろ.jpg" alt="ゲリラホーク戦" loading="lazy">
                    <div class="gallery-caption">ゲリラホーク戦</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_15_マナ族_くろろ.jpg', 'マナ族')">
                    <img src="../../source/AnotherX/Gallery/02_15_マナ族_くろろ.jpg" alt="マナ族" loading="lazy">
                    <div class="gallery-caption">マナ族</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_16_ソウゲン村_シン_くろろ.jpg', 'ソウゲン村（シン）')">
                    <img src="../../source/AnotherX/Gallery/02_16_ソウゲン村_シン_くろろ.jpg" alt="ソウゲン村（シン）" loading="lazy">
                    <div class="gallery-caption">ソウゲン村（シン）</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_18_伐採用斧_くろろ.jpg', '伐採用斧')">
                    <img src="../../source/AnotherX/Gallery/02_18_伐採用斧_くろろ.jpg" alt="伐採用斧" loading="lazy">
                    <div class="gallery-caption">伐採用斧</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_20_タトゥホーンの角_くろろ.jpg', 'タトゥホーンの角')">
                    <img src="../../source/AnotherX/Gallery/02_20_タトゥホーンの角_くろろ.jpg" alt="タトゥホーンの角" loading="lazy">
                    <div class="gallery-caption">タトゥホーンの角</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/03_28.5_法螺貝.jpg', '法螺貝')">
                    <img src="../../source/AnotherX/Gallery/03_28.5_法螺貝.jpg" alt="法螺貝" loading="lazy">
                    <div class="gallery-caption">法螺貝</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/03_33_難破船.jpg', '難破船')">
                    <img src="../../source/AnotherX/Gallery/03_33_難破船.jpg" alt="難破船" loading="lazy">
                    <div class="gallery-caption">難破船</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/03_34_記憶の水兵.jpg', '記憶の水兵')">
                    <img src="../../source/AnotherX/Gallery/03_34_記憶の水兵.jpg" alt="記憶の水兵" loading="lazy">
                    <div class="gallery-caption">記憶の水兵</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/パン.jpg', 'パン')">
                    <img src="../../source/AnotherX/Gallery/パン.jpg" alt="パン" loading="lazy">
                    <div class="gallery-caption">パン</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/皿.jpg', '皿')">
                    <img src="../../source/AnotherX/Gallery/皿.jpg" alt="皿" loading="lazy">
                    <div class="gallery-caption">皿</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/麦.jpg', '麦')">
                    <img src="../../source/AnotherX/Gallery/麦.jpg" alt="麦" loading="lazy">
                    <div class="gallery-caption">麦</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ライトボックス -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
            <img id="lightbox-image" src="" alt="">
            <div id="lightbox-caption"></div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 ゆうえんち. All Rights Reserved.</p>
    </footer>

    <script src="anotherx-content.js"></script>
    <script>
        // エピソードコンテンツの遅延読み込み管理
        let localEpisodeContents = null;
        let isLoadingContent = false;
        let loadedEpisodes = new Set();

        // コンテンツファイルの遅延読み込み
        async function loadEpisodeContent() {
            if (localEpisodeContents) return localEpisodeContents;
            
            try {
                isLoadingContent = true;
                console.log('エピソードコンテンツを読み込み中...');
                
                // 動的にスクリプトを読み込み
                const script = document.createElement('script');
                script.src = 'anotherx-content.js';
                script.async = true;
                
                return new Promise((resolve, reject) => {
                    script.onload = () => {
                        // グローバル変数からコンテンツを取得
                        if (typeof episodeContents !== 'undefined') {
                            localEpisodeContents = episodeContents;
                            console.log('エピソードコンテンツの読み込み完了');
                            isLoadingContent = false;
                            resolve(localEpisodeContents);
                        } else {
                            reject(new Error('コンテンツの読み込みに失敗しました'));
                        }
                    };
                    script.onerror = () => reject(new Error('スクリプトの読み込みに失敗しました'));
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('コンテンツ読み込みエラー:', error);
                isLoadingContent = false;
                throw error;
            }
        }

        // 特定のエピソードのコンテンツを取得
        async function getEpisodeContent(episode) {
            if (!localEpisodeContents) {
                await loadEpisodeContent();
            }
            return localEpisodeContents[episode];
        }

        document.addEventListener('DOMContentLoaded', function() {
            const episodeCards = document.querySelectorAll('.episode-card');
            const chapters = [
                {
                    title: '第1章',
                    episodes: [
                        { num: '1', title: '旅路' },
                        { num: '2', title: '森での戦い' },
                        { num: '3', title: 'ピンク髪の女の子' },
                        { num: '4', title: 'モネ' },
                        { num: '5', title: '渓谷のかくれんぼ' },
                        { num: '6', title: 'モリの村' },
                        { num: '6.5', title: '寝顔' },
                        { num: '7', title: '遺跡に巣食うもの' },
                        { num: '8', title: '洞窟に潜むもの' },
                        { num: '9', title: '薬学の心得' },
                        { num: '10', title: 'ゲリラホーク戦' },
                        { num: '11', title: '怪鳥と異変' },
                        { num: '12', title: 'ノンの作戦' },
                        { num: '13', title: 'エーテル' }
                    ]
                },
                {
                    title: '第2章',
                    episodes: [
                        { num: '14', title: '行商人' },
                        { num: '15', title: 'マナ族' },
                        { num: '16', title: 'ソウゲン村' },
                        { num: '17_main', title: 'ミドリさん家にて' },
                        { num: '17_sub', title: '笛の音と正しさの意味' },
                        { num: '18', title: '危険な知らせ' },
                        { num: '19', title: 'タトゥホーン戦' },
                        { num: '20', title: '戦利品' },
                        { num: '21', title: 'ターゲット' },
                        { num: '22', title: 'クロウ' },
                        { num: '23', title: '位相反転' },
                        { num: '24', title: '猪肉祭り～笛の音と共に～' }
                    ]
                }
            ];
            let currentChapter = 0;
            let contentPanel = document.querySelector('.content-panel');
            const chapterTitle = document.querySelector('.bookshelf h2');
            const episodesList = document.querySelector('.episodes-list');

            function renderChapter(chapterIdx) {
                // 章タイトル更新
                chapterTitle.textContent = chapters[chapterIdx].title;
                // エピソードリスト更新
                episodesList.innerHTML = '';
                chapters[chapterIdx].episodes.forEach(ep => {
                    const card = document.createElement('div');
                    card.className = 'episode-card';
                    card.setAttribute('data-episode', ep.num);
                    card.setAttribute('data-title', ep.title);
                    card.innerHTML = `<div class="episode-number">Episode ${ep.num}</div><h3>${ep.title}</h3>`;
                    card.addEventListener('click', async function() {
                        document.querySelectorAll('.episode-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        await loadContent(ep.num, ep.title);
                        window.currentEpisode = ep.num;
                    });
                    episodesList.appendChild(card);
                });
            }

            // エピソードカードクリック時の処理
            episodeCards.forEach(card => {
                card.addEventListener('click', async function() {
                    // アクティブクラスを削除
                    episodeCards.forEach(c => c.classList.remove('active'));
                    
                    // クリックされたカードにアクティブクラスを追加
                    this.classList.add('active');
                    
                    // コンテンツを表示
                    const episode = this.getAttribute('data-episode');
                    const title = this.getAttribute('data-title');
                    await loadContent(episode, title);
                    
                    // グローバル変数を更新
                    window.currentEpisode = parseInt(episode);
                });
            });

            // キーボードイベントリスナーを追加
            document.addEventListener('keydown', function(event) {
                // エピソードが選択されている場合のみキー操作を有効にする
                if (window.currentEpisode && window.totalPages) {
                    if (event.key === 'ArrowLeft') {
                        // 左矢印キーで前のページ
                        event.preventDefault();
                        changePage(-1);
                    } else if (event.key === 'ArrowRight') {
                        // 右矢印キーで次のページ
                        event.preventDefault();
                        changePage(1);
                    }
                }
                
                // エピソード切り替え（Ctrl + 矢印キー）
                if (event.ctrlKey && window.currentEpisode) {
                    if (event.key === 'ArrowLeft') {
                        // Ctrl + 左矢印キーで前のエピソード
                        event.preventDefault();
                        changeEpisode(-1);
                    } else if (event.key === 'ArrowRight') {
                        // Ctrl + 右矢印キーで次のエピソード
                        event.preventDefault();
                        changeEpisode(1);
                    }
                }
            });

            // コンテンツ表示関数（非同期版）
            async function loadContent(episode, title) {
                if (!contentPanel) return;
                
                try {
                    console.log(`エピソード ${episode} の読み込み開始`);
                    
                    // ローディング表示
                    contentPanel.innerHTML = `
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <p>エピソードを読み込み中...</p>
                        </div>
                    `;
                    
                    const episodeData = await getEpisodeContent(episode);
                    console.log(`エピソード ${episode} のデータ:`, episodeData);
                    
                    const maxEpisode = chapters[currentChapter].episodes[chapters[currentChapter].episodes.length - 1].num;
                    
                    if (episodeData) {
                        // テキストを空行で分割
                        const pages = episodeData.content.split('\n\n').filter(page => page.trim() !== '');
                        console.log(`ページ数: ${pages.length}`);
                        
                        let pagesHTML = '';
                        pages.forEach((page, index) => {
                            pagesHTML += `
                                <div class="page ${index === 0 ? 'active' : ''}" data-page="${index}">
                                    <div class="page-content">${page.trim()}</div>
                                </div>
                            `;
                        });
                        
                        contentPanel.innerHTML = `
                            <div class="content-text">
                                <div class="left-column">
                                    <img src="../../source/AnotherX/モネ.png" alt="モネ" class="title-image">
                                    <div class="auto-control">
                                        <div class="auto-container">
                                            <button id="auto-button" class="auto-button" onclick="toggleAuto()">
                                                <span class="auto-icon">▶</span>
                                                <span class="auto-text">Auto</span>
                                            </button>
                                            <div class="auto-timer">
                                                <input type="number" id="auto-interval" class="auto-input" value="3.0" min="0.1" max="60.0" step="0.1">
                                                <div class="auto-buttons">
                                                    <button class="auto-up" onclick="adjustInterval(0.1)">▲</button>
                                                    <button class="auto-down" onclick="adjustInterval(-0.1)">▼</button>
                                                </div>
                                                <span class="auto-unit">秒</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="page-info">
                                        <span id="current-page">1</span> / <span id="total-pages">${pages.length}</span>
                                    </div>
                                </div>
                                <div class="right-column">
                                    <h2 class="episode-title">${episodeData.title}</h2>
                                    <div class="page-container">
                                        ${pagesHTML}
                                        <div class="page-navigation">
                                            <button class="nav-button" id="prev-page" onclick="changePage(-1)" disabled>
                                                ‹
                                            </button>
                                            <button class="nav-button" id="next-page" onclick="changePage(1)" ${pages.length <= 1 ? 'disabled' : ''}>
                                                ›
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="episode-navigation">
                                <button class="episode-nav-button" id="prev-episode" onclick="changeEpisode(-1)" ${episode == chapters[currentChapter].episodes[0].num ? 'disabled' : ''}>
                                    ← 前のエピソード
                                </button>
                                <div class="episode-nav-info">
                                    Episode ${episode} / ${maxEpisode}
                                </div>
                                <button class="episode-nav-button" id="next-episode" onclick="changeEpisode(1)" ${episode == maxEpisode ? 'disabled' : ''}>
                                    次のエピソード →
                                </button>
                            </div>
                        `;
                        
                        // グローバル変数にページ情報を保存
                        window.currentPageIndex = 0;
                        window.totalPages = pages.length;
                        
                        // 自動再生を停止
                        if (autoInterval) {
                            toggleAuto();
                        }
                        
                        // 時間設定フィールドのイベントリスナーを設定
                        setTimeout(() => {
                            const intervalInput = document.getElementById('auto-interval');
                            if (intervalInput) {
                                intervalInput.addEventListener('input', function() {
                                    // 自動再生中の場合、新しい間隔で再設定
                                    if (autoInterval) {
                                        toggleAuto(); // 一度停止
                                        setTimeout(() => {
                                            toggleAuto(); // 新しい間隔で再開
                                        }, 100);
                                    }
                                });
                            }
                        }, 100);
                        
                        // 読み込み済みエピソードとして記録
                        loadedEpisodes.add(episode);
                        console.log(`エピソード ${episode} の読み込み完了`);
                        
                    } else {
                        console.log(`エピソード ${episode} のデータが見つかりません`);
                        contentPanel.innerHTML = `
                            <h2>${title}</h2>
                            <div class="no-content">
                                <p>このエピソードのコンテンツが見つかりませんでした。</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('エピソード読み込みエラー:', error);
                    contentPanel.innerHTML = `
                        <div class="error-content">
                            <h2>${title}</h2>
                            <p>エピソードの読み込みに失敗しました。</p>
                            <button onclick="loadContent('${episode}', '${title}')" class="retry-button">再試行</button>
                        </div>
                    `;
                }
            }

            // ページめくり関数
            window.changePage = function(direction) {
                const pages = document.querySelectorAll('.page');
                const prevButton = document.getElementById('prev-page');
                const nextButton = document.getElementById('next-page');
                const currentPageSpan = document.getElementById('current-page');
                
                if (direction === 1 && window.currentPageIndex < window.totalPages - 1) {
                    // 次のページへ
                    const currentPage = pages[window.currentPageIndex];
                    const nextPage = pages[window.currentPageIndex + 1];
                    
                    // フェードアウト
                    currentPage.classList.remove('active');
                    currentPage.classList.add('prev');
                    
                    // 少し遅延してからフェードイン
                    setTimeout(() => {
                        // すべてのページのprevクラスをクリア
                        pages.forEach(page => page.classList.remove('prev'));
                        nextPage.classList.add('active');
                    }, 100);
                    
                    window.currentPageIndex++;
                } else if (direction === -1 && window.currentPageIndex > 0) {
                    // 前のページへ
                    const currentPage = pages[window.currentPageIndex];
                    const prevPage = pages[window.currentPageIndex - 1];
                    
                    // フェードアウト
                    currentPage.classList.remove('active');
                    currentPage.classList.add('prev');
                    
                    // 少し遅延してからフェードイン
                    setTimeout(() => {
                        // すべてのページのprevクラスをクリア
                        pages.forEach(page => page.classList.remove('prev'));
                        prevPage.classList.add('active');
                    }, 100);
                    
                    window.currentPageIndex--;
                }
                
                // ボタンの状態を更新
                prevButton.disabled = window.currentPageIndex === 0;
                nextButton.disabled = window.currentPageIndex === window.totalPages - 1;
                
                // ページ番号を更新
                currentPageSpan.textContent = window.currentPageIndex + 1;
            };
            
            // エピソード切り替え関数
            window.changeEpisode = async function(direction) {
                const currentEpisode = parseInt(window.currentEpisode || 1);
                const newEpisode = currentEpisode + direction;
                
                if (newEpisode >= 1 && newEpisode <= 14) {
                    // アクティブなエピソードカードを更新
                    episodeCards.forEach(c => c.classList.remove('active'));
                    const targetCard = document.querySelector(`[data-episode="${newEpisode}"]`);
                    if (targetCard) {
                        targetCard.classList.add('active');
                    }
                    
                    // 新しいエピソードのコンテンツを読み込み
                    const title = targetCard.getAttribute('data-title');
                    await loadContent(newEpisode.toString(), title);
                    
                    // グローバル変数を更新
                    window.currentEpisode = newEpisode;
                }
            };
            
            // 自動ページめくり機能
            let autoInterval = null;
            
            window.toggleAuto = function() {
                const autoButton = document.getElementById('auto-button');
                const autoIcon = autoButton.querySelector('.auto-icon');
                const autoText = autoButton.querySelector('.auto-text');
                const intervalInput = document.getElementById('auto-interval');
                
                if (autoInterval) {
                    // 自動再生を停止
                    clearInterval(autoInterval);
                    autoInterval = null;
                    autoButton.classList.remove('active');
                    autoIcon.textContent = '▶';
                    autoText.textContent = 'Auto';
                } else {
                    // 自動再生を開始
                    autoButton.classList.add('active');
                    autoIcon.textContent = '⏸';
                    autoText.textContent = 'Stop';
                    
                    // 設定された間隔で自動ページめくり
                    const interval = parseFloat(intervalInput.value) * 1000; // 秒をミリ秒に変換
                    autoInterval = setInterval(() => {
                        // 最後のページでない場合は次のページへ
                        if (window.currentPageIndex < window.totalPages - 1) {
                            changePage(1);
                        } else {
                            // 最後のページの場合は自動再生を停止
                            toggleAuto();
                        }
                    }, interval);
                }
            };
            
            // 時間間隔調整機能
            window.adjustInterval = function(change) {
                const intervalInput = document.getElementById('auto-interval');
                let currentValue = parseFloat(intervalInput.value);
                let newValue = currentValue + change;
                
                // 最小値と最大値を制限
                newValue = Math.max(0.1, Math.min(60.0, newValue));
                
                // 小数点第1位まで表示
                intervalInput.value = newValue.toFixed(1);
                
                // 自動再生中の場合、新しい間隔で再設定
                if (autoInterval) {
                    toggleAuto(); // 一度停止
                    setTimeout(() => {
                        toggleAuto(); // 新しい間隔で再開
                    }, 100);
                }
            };
            

        });
        
        // ライトボックス機能
        function openLightbox(imageSrc, caption) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxCaption = document.getElementById('lightbox-caption');
            
            lightboxImage.src = imageSrc;
            lightboxCaption.textContent = caption;
            lightbox.style.display = 'block';
            
            // ESCキーでライトボックスを閉じる
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeLightbox();
                }
            });
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'none';
        }
    </script>

    <!-- ローディングとエラー表示用のCSS -->
    <style>
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-content {
            text-align: center;
            padding: 2rem;
        }
        
        .retry-button {
            background: linear-gradient(45deg, #4a90e2, #5cb85c);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 1rem;
        }
        
        .retry-button:hover {
            background: linear-gradient(45deg, #5cb85c, #4a90e2);
        }
        
        /* ギャラリーセクション */
        .gallery-section {
            background: linear-gradient(135deg, #F5F5DC 0%, #FDF5E6 50%, #F5F5DC 100%);
            border: 3px solid #8B4513;
            border-radius: 12px;
            margin: 2rem auto;
            max-width: 1300px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .gallery-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            border-radius: 12px 12px 0 0;
        }
        
        .gallery-section h3 {
            text-align: center;
            color: #8B4513;
            font-size: 1.5rem;
            margin: 0 0 1.5rem 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-weight: bold;
            position: relative;
            z-index: 1;
        }
        
        .gallery-section h3::before {
            content: '🖼️';
            margin-right: 0.5rem;
        }
        
        .gallery-description {
            text-align: center;
            color: #8B4513;
            font-size: 1rem;
            margin: 0 0 1.5rem 0;
            font-style: italic;
            opacity: 0.8;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            position: relative;
            z-index: 1;
        }
        
        .gallery-item {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 50%, #8B0000 100%);
            border: 2px solid #654321;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .gallery-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            z-index: 2;
        }
        
        .gallery-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-bottom: 2px solid #654321;
        }
        
        .gallery-item:hover img {
            transform: scale(1.02);
        }
        
        .gallery-caption {
            padding: 0.8rem;
            text-align: center;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #D2691E 0%, #FF8C00 50%, #D2691E 100%);
            font-size: 0.9rem;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .gallery-caption::before {
            content: '📖';
            margin-right: 0.3rem;
        }
        
        /* World Map Miruze セクション */
        .world-map-section {
            background: linear-gradient(135deg, #F5F5DC 0%, #FDF5E6 50%, #F5F5DC 100%);
            border: 3px solid #8B4513;
            border-radius: 12px;
            margin: 2rem auto;
            max-width: 1300px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .world-map-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            border-radius: 12px 12px 0 0;
        }
        
        .world-map-section h3 {
            text-align: center;
            color: #8B4513;
            font-size: 1.5rem;
            margin: 0 0 1.5rem 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-weight: bold;
            position: relative;
            z-index: 1;
        }
        
        .world-map-section h3::before {
            content: '🗺️';
            margin-right: 0.5rem;
        }
        
        .world-map-description {
            text-align: center;
            color: #8B4513;
            font-size: 1rem;
            margin: 0 0 1.5rem 0;
            font-style: italic;
            opacity: 0.8;
        }
        
        .world-map-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .world-map-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid #654321;
            transition: transform 0.3s ease;
        }
        
        .world-map-image:hover {
            transform: scale(1.02);
        }
        
        /* ライトボックス */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }
        
        .lightbox-content {
            position: relative;
            margin: auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            transition: color 0.3s ease;
        }
        
        .lightbox-close:hover {
            color: #bbb;
        }
        
        #lightbox-image {
            max-width: 100%;
            max-height: 80%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        #lightbox-caption {
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .gallery-item img {
                height: 120px;
            }
            
            .lightbox-content {
                width: 95%;
                height: 95%;
            }
            
            .lightbox-close {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
        }
    </style>
</body>
</html> 