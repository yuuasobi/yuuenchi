<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnotherX - 図書館</title>
    <link rel="icon" type="image/png" href="../../source/観覧車ファビコン.png">
    <link rel="shortcut icon" type="image/png" href="../../source/観覧車ファビコン.png">
    <link rel="apple-touch-icon" href="../../source/観覧車ファビコン.png">
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="anotherx-style.css">
</head>
<body>
    <script src="../../header.js"></script>
    
    <header class="library-header">
        <h1>📚 AnotherX 📚</h1>
    </header>
    
    <div class="container">
        <div class="tab-content-wrapper">
                               <!-- あらすじセクション -->
                   <div class="introduction-section">
                       <div class="container">
                           <h3>📖 あらすじ</h3>
                    <div class="introduction-content" id="introduction-content">
                        <p>ハツノ村出身のゼンと、獣の姿をしたマナ族のモネ。2年間の旅を終え、故郷への帰路についていた2人は、森でピンク髪の女性・ノンと出会う。彼女は遺跡の調査を目的とした旅の途中だった。</p>
                        <p>種族を超えた友情と信頼関係を築きながら、仲間と協力して困難に立ち向かう冒険物語。モネの尻尾でのコミュニケーションや、ノンの薬学知識を活かした戦闘など、独特な世界観と魅力的なキャラクターたちが織りなす心温まるファンタジーストーリーの幕開け。</p>
                    </div>
                </div>
            </div>
            
            <!-- タブボタン -->
            <div class="tab-container">
                <button class="tab-button active" data-chapter="0">第1章</button>
                <button class="tab-button" data-chapter="1">第2章</button>
                <button class="tab-button" data-chapter="2">第3章</button>
                <button class="tab-button" data-chapter="3">第4章</button>
                <button class="tab-button" data-chapter="4">第5章</button>
                <button class="tab-button" data-chapter="5">第6章</button>
            </div>
            
            <div class="library-content">
                <div class="bookshelf">
                <h2>第1章</h2>
                <div class="episodes-list">
                    <div class="episode-card" data-episode="1" data-title="旅路">
                        <div class="episode-number">Episode 1</div>
                        <h3>旅路</h3>
                    </div>
                    <div class="episode-card" data-episode="2" data-title="森での戦い">
                        <div class="episode-number">Episode 2</div>
                        <h3>森での戦い</h3>
                    </div>
                    <div class="episode-card" data-episode="3" data-title="ピンク髪の女の子">
                        <div class="episode-number">Episode 3</div>
                        <h3>ピンク髪の女の子</h3>
                    </div>
                    <div class="episode-card" data-episode="4" data-title="モネ">
                        <div class="episode-number">Episode 4</div>
                        <h3>モネ</h3>
                    </div>
                    <div class="episode-card" data-episode="5" data-title="渓谷のかくれんぼ">
                        <div class="episode-number">Episode 5</div>
                        <h3>渓谷のかくれんぼ</h3>
                    </div>
                    <div class="episode-card" data-episode="6" data-title="モリの村">
                        <div class="episode-number">Episode 6</div>
                        <h3>モリの村</h3>
                    </div>
                    <div class="episode-card" data-episode="6.5" data-title="寝顔">
                        <div class="episode-number">Episode 6.5</div>
                        <h3>寝顔</h3>
                    </div>
                    <div class="episode-card" data-episode="7" data-title="遺跡に巣食うもの">
                        <div class="episode-number">Episode 7</div>
                        <h3>遺跡に巣食うもの</h3>
                    </div>
                    <div class="episode-card" data-episode="8" data-title="洞窟に潜むもの">
                        <div class="episode-number">Episode 8</div>
                        <h3>洞窟に潜むもの</h3>
                    </div>
                    <div class="episode-card" data-episode="9" data-title="薬学の心得">
                        <div class="episode-number">Episode 9</div>
                        <h3>薬学の心得</h3>
                    </div>
                    <div class="episode-card" data-episode="10" data-title="ゲリラホーク戦">
                        <div class="episode-number">Episode 10</div>
                        <h3>ゲリラホーク戦</h3>
                    </div>
                    <div class="episode-card" data-episode="11" data-title="怪鳥と異変">
                        <div class="episode-number">Episode 11</div>
                        <h3>怪鳥と異変</h3>
                    </div>
                    <div class="episode-card" data-episode="12" data-title="ノンの作戦">
                        <div class="episode-number">Episode 12</div>
                        <h3>ノンの作戦</h3>
                    </div>
                    <div class="episode-card" data-episode="13" data-title="エーテル">
                        <div class="episode-number">Episode 13</div>
                        <h3>エーテル</h3>
                    </div>
                </div>
            </div>
            <div class="content-panel">
                <div class="no-content">
                    <img src="../../source/AnotherX/アナザークロス_サムネイル.png" alt="AnotherX サムネイル" class="thumbnail-image">
                    <p class="novel-description">AnotherXは長編ファンタジーのテロップ形式で読む小説です</p>
                    <h2>📖 左のリストからエピソードを選択してください</h2>
                </div>
            </div>
        </div>
    </div>



    <div class="world-map-section">
        <div class="container">
            <h3>🗺️ World Map Miruze</h3>
            <p class="world-map-description">illustration by kuroro</p>
            <div class="world-map-container">
                <img src="../../source/AnotherX/miruze_map.jpg" alt="World Map Miruze" class="world-map-image">
            </div>
        </div>
    </div>

    <div class="gallery-section">
        <div class="container">
            <h3>🖼️ Kuroro Gallery</h3>
            <div class="gallery-grid">
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_01_焚火_AnotherX_くろろ.jpg', '焚火')">
                    <img src="../../source/AnotherX/Gallery/01_01_焚火_AnotherX_くろろ.jpg" alt="焚火" loading="lazy">
                    <div class="gallery-caption">焚火</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_02_きのこ_AnotherX_くろろ.jpg', 'きのこ')">
                    <img src="../../source/AnotherX/Gallery/01_02_きのこ_AnotherX_くろろ.jpg" alt="きのこ" loading="lazy">
                    <div class="gallery-caption">きのこ</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_02_ゴブリン_AnotherX_くろろ.jpg', 'ゴブリン')">
                    <img src="../../source/AnotherX/Gallery/01_02_ゴブリン_AnotherX_くろろ.jpg" alt="ゴブリン" loading="lazy">
                    <div class="gallery-caption">ゴブリン</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_03_ノン_AnotherX_くろろ.jpg', 'ノン')">
                    <img src="../../source/AnotherX/Gallery/01_03_ノン_AnotherX_くろろ.jpg" alt="ノン" loading="lazy">
                    <div class="gallery-caption">ノン</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_04_鍋_AnotherX_くろろ.jpg', '鍋')">
                    <img src="../../source/AnotherX/Gallery/01_04_鍋_AnotherX_くろろ.jpg" alt="鍋" loading="lazy">
                    <div class="gallery-caption">鍋</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_04_料理_AnotherX_くろろ.jpg', '料理')">
                    <img src="../../source/AnotherX/Gallery/01_04_料理_AnotherX_くろろ.jpg" alt="料理" loading="lazy">
                    <div class="gallery-caption">料理</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_05_モネ白_AnotherX_くろろ.jpg', 'モネ（白）')">
                    <img src="../../source/AnotherX/Gallery/01_05_モネ白_AnotherX_くろろ.jpg" alt="モネ（白）" loading="lazy">
                    <div class="gallery-caption">モネ（白）</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_05_モネ黒_AnotherX_くろろ.jpg', 'モネ（黒）')">
                    <img src="../../source/AnotherX/Gallery/01_05_モネ黒_AnotherX_くろろ.jpg" alt="モネ（黒）" loading="lazy">
                    <div class="gallery-caption">モネ（黒）</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_10_ゲリラホーク_AnotherX_くろろ.jpg', 'ゲリラホーク')">
                    <img src="../../source/AnotherX/Gallery/01_10_ゲリラホーク_AnotherX_くろろ.jpg" alt="ゲリラホーク" loading="lazy">
                    <div class="gallery-caption">ゲリラホーク</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/01_10_ゲリラホーク戦_AnotherX_くろろ.jpg', 'ゲリラホーク戦')">
                    <img src="../../source/AnotherX/Gallery/01_10_ゲリラホーク戦_AnotherX_くろろ.jpg" alt="ゲリラホーク戦" loading="lazy">
                    <div class="gallery-caption">ゲリラホーク戦</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_15_マナ族_くろろ.jpg', 'マナ族')">
                    <img src="../../source/AnotherX/Gallery/02_15_マナ族_くろろ.jpg" alt="マナ族" loading="lazy">
                    <div class="gallery-caption">マナ族</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_16_ソウゲン村_シン_くろろ.jpg', 'ソウゲン村（シン）')">
                    <img src="../../source/AnotherX/Gallery/02_16_ソウゲン村_シン_くろろ.jpg" alt="ソウゲン村（シン）" loading="lazy">
                    <div class="gallery-caption">ソウゲン村（シン）</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_18_伐採用斧_くろろ.jpg', '伐採用斧')">
                    <img src="../../source/AnotherX/Gallery/02_18_伐採用斧_くろろ.jpg" alt="伐採用斧" loading="lazy">
                    <div class="gallery-caption">伐採用斧</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/02_20_タトゥホーンの角_くろろ.jpg', 'タトゥホーンの角')">
                    <img src="../../source/AnotherX/Gallery/02_20_タトゥホーンの角_くろろ.jpg" alt="タトゥホーンの角" loading="lazy">
                    <div class="gallery-caption">タトゥホーンの角</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/03_28.5_法螺貝.jpg', '法螺貝')">
                    <img src="../../source/AnotherX/Gallery/03_28.5_法螺貝.jpg" alt="法螺貝" loading="lazy">
                    <div class="gallery-caption">法螺貝</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/03_33_難破船.jpg', '難破船')">
                    <img src="../../source/AnotherX/Gallery/03_33_難破船.jpg" alt="難破船" loading="lazy">
                    <div class="gallery-caption">難破船</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/03_34_記憶の水兵.jpg', '記憶の水兵')">
                    <img src="../../source/AnotherX/Gallery/03_34_記憶の水兵.jpg" alt="記憶の水兵" loading="lazy">
                    <div class="gallery-caption">記憶の水兵</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/パン.jpg', 'パン')">
                    <img src="../../source/AnotherX/Gallery/パン.jpg" alt="パン" loading="lazy">
                    <div class="gallery-caption">パン</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/皿.jpg', '皿')">
                    <img src="../../source/AnotherX/Gallery/皿.jpg" alt="皿" loading="lazy">
                    <div class="gallery-caption">皿</div>
                </div>
                <div class="gallery-item" onclick="openLightbox('../../source/AnotherX/Gallery/麦.jpg', '麦')">
                    <img src="../../source/AnotherX/Gallery/麦.jpg" alt="麦" loading="lazy">
                    <div class="gallery-caption">麦</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ライトボックス -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
            <img id="lightbox-image" src="" alt="">
            <div id="lightbox-caption"></div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 ゆうえんち. All Rights Reserved.</p>
    </footer>

    <script src="anotherx-content.js"></script>
    <script>
        // エピソードコンテンツの遅延読み込み管理
        let localEpisodeContents = null;
        let isLoadingContent = false;
        let loadedEpisodes = new Set();

        // コンテンツファイルの遅延読み込み
        async function loadEpisodeContent() {
            if (localEpisodeContents) return localEpisodeContents;
            
            try {
                isLoadingContent = true;
                console.log('エピソードコンテンツを読み込み中...');
                
                // 動的にスクリプトを読み込み
                const script = document.createElement('script');
                script.src = 'anotherx-content.js';
                script.async = true;
                
                return new Promise((resolve, reject) => {
                    script.onload = () => {
                        // グローバル変数からコンテンツを取得
                        if (typeof episodeContents !== 'undefined') {
                            localEpisodeContents = episodeContents;
                            console.log('エピソードコンテンツの読み込み完了');
                            isLoadingContent = false;
                            resolve(localEpisodeContents);
                        } else {
                            reject(new Error('コンテンツの読み込みに失敗しました'));
                        }
                    };
                    script.onerror = () => reject(new Error('スクリプトの読み込みに失敗しました'));
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('コンテンツ読み込みエラー:', error);
                isLoadingContent = false;
                throw error;
            }
        }

        // 特定のエピソードのコンテンツを取得
        async function getEpisodeContent(episode) {
            if (!localEpisodeContents) {
                await loadEpisodeContent();
            }
            return localEpisodeContents[episode];
        }

        document.addEventListener('DOMContentLoaded', function() {
            const episodeCards = document.querySelectorAll('.episode-card');
            const chapters = [
                {
                    title: '第1章',
                    episodes: [
                        { num: '1', title: '旅路' },
                        { num: '2', title: '森での戦い' },
                        { num: '3', title: 'ピンク髪の女の子' },
                        { num: '4', title: 'モネ' },
                        { num: '5', title: '渓谷のかくれんぼ' },
                        { num: '6', title: 'モリの村' },
                        { num: '6.5', title: '寝顔' },
                        { num: '7', title: '遺跡に巣食うもの' },
                        { num: '8', title: '洞窟に潜むもの' },
                        { num: '9', title: '薬学の心得' },
                        { num: '10', title: 'ゲリラホーク戦' },
                        { num: '11', title: '怪鳥と異変' },
                        { num: '12', title: 'ノンの作戦' },
                        { num: '13', title: 'エーテル' }
                    ]
                },
                {
                    title: '第2章',
                    episodes: [
                        { num: '14', title: '行商人' },
                        { num: '15', title: 'マナ族' },
                        { num: '16', title: 'ソウゲン村' },
                        { num: '17_main', title: 'ミドリさん家にて' },
                        { num: '17_sub', title: '笛の音と正しさの意味' },
                        { num: '18', title: '危険な知らせ' },
                        { num: '19', title: 'タトゥホーン戦' },
                        { num: '20', title: '戦利品' },
                        { num: '21', title: 'ターゲット' },
                        { num: '22', title: 'クロウ' },
                        { num: '23', title: '位相反転' },
                        { num: '24', title: '猪肉祭り～笛の音と共に～' }
                    ]
                },
                {
                    title: '第3章',
                    episodes: [
                        { num: '25', title: 'マウを求めて' },
                        { num: '26', title: '海を越えた先の地' },
                        { num: '27', title: '港町トゥカイ' },
                        { num: '28', title: '海賊の襲撃' },
                        { num: '28.5', title: '法螺貝の音' },
                        { num: '29', title: '海の記憶' },
                        { num: '30', title: '記憶の水兵' },
                        { num: '31', title: '航海の果て' },
                        { num: '32', title: '新たな冒険' },
                        { num: '33', title: '難破船' },
                        { num: '34', title: '記憶の水兵' },
                        { num: '35', title: '海の彼方' },
                        { num: '36', title: '港町の秘密' },
                        { num: '37', title: '航海の終わり' }
                    ]
                },
                {
                    title: '第4章',
                    episodes: [
                        { num: '38', title: '訪問者' },
                        { num: '39', title: '踊り子島と美しさの価値観' },
                        { num: '40_main', title: '踊り子の服' },
                        { num: '40_sub', title: '美しさの定義' },
                        { num: '41', title: '島の秘密' },
                        { num: '42', title: '踊り子たち' },
                        { num: '43', title: '美の追求' },
                        { num: '44', title: '島の伝統' },
                        { num: '45', title: '踊り子の決意' },
                        { num: '46', title: '美しさの真実' },
                        { num: '47', title: '島を出る日' }
                    ]
                },
                {
                    title: '第5章',
                    episodes: [
                        { num: '50', title: 'また会うその日まで' },
                        { num: '51', title: '護衛役' },
                        { num: '52', title: '黄金色の村' },
                        { num: '53', title: '村の秘密' },
                        { num: '54', title: '黄金の伝説' },
                        { num: '55', title: '村人たち' },
                        { num: '56', title: '黄金の力' },
                        { num: '57', title: '村の危機' },
                        { num: '58', title: '黄金の真実' },
                        { num: '59', title: '村を守る' },
                        { num: '60', title: '黄金の選択' },
                        { num: '61', title: '村の未来' },
                        { num: '62', title: '黄金の約束' }
                    ]
                },
                {
                    title: '第6章',
                    episodes: [
                        { num: '63', title: '帰還と招待とお誘いと' },
                        { num: '64', title: '王座の間へと続く道' },
                        { num: '65', title: '二人の姫君と晩餐会' },
                        { num: '66', title: '宮廷の秘密' },
                        { num: '67', title: '姫君たち' },
                        { num: '68', title: '王座の間' },
                        { num: '69', title: '皇帝の真意' },
                        { num: '70', title: '宮廷の陰謀' },
                        { num: '71', title: '姫君の選択' },
                        { num: '72', title: '王座の決断' },
                        { num: '73', title: '宮廷の未来' },
                        { num: '74', title: '皇帝と娘' },
                        { num: '75', title: '宝石の名を冠するもの' },
                        { num: '76', title: '故郷に向けて' },
                        { num: '77', title: '旅の終わり' }
                    ]
                }
            ];
            let currentChapter = 0;
            let contentPanel = document.querySelector('.content-panel');
            const chapterTitle = document.querySelector('.bookshelf h2');
            const episodesList = document.querySelector('.episodes-list');

            function renderChapter(chapterIdx) {
                // 章タイトル更新
                chapterTitle.textContent = chapters[chapterIdx].title;
                // エピソードリスト更新
                episodesList.innerHTML = '';
                chapters[chapterIdx].episodes.forEach(ep => {
                    const card = document.createElement('div');
                    card.className = 'episode-card';
                    card.setAttribute('data-episode', ep.num);
                    card.setAttribute('data-title', ep.title);
                    card.innerHTML = `<div class="episode-number">Episode ${ep.num}</div><h3>${ep.title}</h3>`;
                    card.addEventListener('click', async function() {
                        document.querySelectorAll('.episode-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        await loadContent(ep.num, ep.title);
                        window.currentEpisode = ep.num;
                    });
                    episodesList.appendChild(card);
                });
                
                // 紹介文を更新
                updateIntroduction(chapterIdx);
            }
            
            // 紹介文更新関数
            function updateIntroduction(chapterIdx) {
                const introductionContent = document.getElementById('introduction-content');
                if (!introductionContent) return;
                
                const introductions = {
                    0: `<p>ハツノ村出身のゼンと、獣の姿をしたマナ族のモネ。2年間の旅を終え、故郷への帰路についていた2人は、森でピンク髪の女性・ノンと出会う。彼女は遺跡の調査を目的とした旅の途中だった。</p><p>種族を超えた友情と信頼関係を築きながら、仲間と協力して困難に立ち向かう冒険物語。モネの尻尾でのコミュニケーションや、ノンの薬学知識を活かした戦闘など、独特な世界観と魅力的なキャラクターたちが織りなす心温まるファンタジーストーリーの幕開け。</p>`,
                    1: `<p>ソウゲン村への旅の途中、行商人ドグとの一期一会の出会い。おにぎりという新しい食文化を通じて、各地の文化の多様性を学ぶ。村では温かい家族との交流があり、村の危機に立ち向かうことで地域コミュニティの絆を深める。</p><p>文化交流と人間関係の深化を描きながら、戦闘技術の向上と新たな仲間との出会いを通じて、冒険の幅を広げる心温まる物語。</p>`,
                    2: `<p>港町トゥカイでの海の文化との出会い。海舞祭の準備やマウの貸出屋での仕事を通じて、海辺の暮らしを体験する。法螺貝の音色や踊り子たちの美しい踊りに触れながら、海の神様への信仰を学ぶ。</p><p>記憶と心という深いテーマを扱いながら、海の文化との融合と家族愛の描写を通じて、物語に哲学的な深みと感動的な魅力を加える章。</p>`,
                    3: `<p>踊り子島での海舞祭への参加。各地から集まる踊り子たちの美しい踊りに触れながら、トゥカイ特有の回転を軸にした踊りの文化を学ぶ。海の神様への願い事や伝統文化の継承を通じて、美しさの価値観について深く考える。</p><p>恋愛感情の芽生えと美しさの価値観の探求を描きながら、伝統文化と神秘的な現象を通じて、物語に深い文化的な魅力と感動的な要素を加える章。</p>`,
                    4: `<p>各地を巡る旅を通じて、黄金色の村やキタノチ山、アルテミス城下町など多様な文化との出会いを体験する。鍛冶屋兄弟の職人技やくるみ菓子の文化を通じて、各地の特色ある文化を学ぶ。</p><p>旅の多様性と新たな仲間との出会いを描きながら、戦闘システムの革新と宝玉という重要な要素の導入を通じて、物語に新たな深みと魅力を加える章。</p>`,
                    5: `<p>アルテミス城での王家との出会い。舞踏会という優雅な社交イベントを通じて、城での地位を確立する。社交ダンスの美しさや王家の歴史に触れながら、新たな仲間との出会いを体験する。</p><p>社交と家族愛を中心とした物語で、舞踏会の優雅さと戦闘の緊張感が織りなすバランスの取れた構成。王家の秘密とマナ族の謎への接近を通じて、物語に深い歴史的背景を加える章。</p>`
                };
                
                introductionContent.innerHTML = introductions[chapterIdx] || introductions[0];
            }

            // エピソードカードクリック時の処理
            episodeCards.forEach(card => {
                card.addEventListener('click', async function() {
                    // アクティブクラスを削除
                    episodeCards.forEach(c => c.classList.remove('active'));
                    
                    // クリックされたカードにアクティブクラスを追加
                    this.classList.add('active');
                    
                    // コンテンツを表示
                    const episode = this.getAttribute('data-episode');
                    const title = this.getAttribute('data-title');
                    await loadContent(episode, title);
                    
                    // グローバル変数を更新
                    window.currentEpisode = parseInt(episode);
                });
            });

            // タブナビゲーションのイベントリスナーを追加
                    document.querySelectorAll('.tab-container .tab-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.tab-container .tab-button').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentChapter = parseInt(this.getAttribute('data-chapter'));
                    renderChapter(currentChapter);
                    // エピソードカードのアクティブ状態をリセット
                    episodeCards.forEach(c => c.classList.remove('active'));
                    const firstEpisodeCard = document.querySelector('.episodes-list .episode-card');
                    if (firstEpisodeCard) {
                        firstEpisodeCard.classList.add('active');
                    }
                    window.currentEpisode = parseInt(firstEpisodeCard.getAttribute('data-episode'));
                });
            });

            // キーボードイベントリスナーを追加
            document.addEventListener('keydown', function(event) {
                // エピソードが選択されている場合のみキー操作を有効にする
                if (window.currentEpisode && window.totalPages) {
                    if (event.key === 'ArrowLeft') {
                        // 左矢印キーで前のページ
                        event.preventDefault();
                        changePage(-1);
                    } else if (event.key === 'ArrowRight') {
                        // 右矢印キーで次のページ
                        event.preventDefault();
                        changePage(1);
                    }
                }
                
                // エピソード切り替え（Ctrl + 矢印キー）
                if (event.ctrlKey && window.currentEpisode) {
                    if (event.key === 'ArrowLeft') {
                        // Ctrl + 左矢印キーで前のエピソード
                        event.preventDefault();
                        changeEpisode(-1);
                    } else if (event.key === 'ArrowRight') {
                        // Ctrl + 右矢印キーで次のエピソード
                        event.preventDefault();
                        changeEpisode(1);
                    }
                }
            });

            // コンテンツ表示関数（非同期版）
            async function loadContent(episode, title) {
                if (!contentPanel) return;
                
                try {
                    console.log(`エピソード ${episode} の読み込み開始`);
                    
                    // ローディング表示
                    contentPanel.innerHTML = `
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <p>エピソードを読み込み中...</p>
                        </div>
                    `;
                    
                    const episodeData = await getEpisodeContent(episode);
                    console.log(`エピソード ${episode} のデータ:`, episodeData);
                    
                    const maxEpisode = chapters[currentChapter].episodes[chapters[currentChapter].episodes.length - 1].num;
                    
                    if (episodeData) {
                        // テキストを空行で分割
                        const pages = episodeData.content.split('\n\n').filter(page => page.trim() !== '');
                        console.log(`ページ数: ${pages.length}`);
                        
                        let pagesHTML = '';
                        pages.forEach((page, index) => {
                            pagesHTML += `
                                <div class="page ${index === 0 ? 'active' : ''}" data-page="${index}">
                                    <div class="page-content">${page.trim()}</div>
                                </div>
                            `;
                        });
                        
                        contentPanel.innerHTML = `
                            <div class="content-text">
                                <div class="left-column">
                                    <img src="../../source/AnotherX/モネ.png" alt="モネ" class="title-image">
                                    <div class="auto-control">
                                        <div class="auto-container">
                                            <button id="auto-button" class="auto-button" onclick="toggleAuto()">
                                                <span class="auto-icon">▶</span>
                                                <span class="auto-text">Auto</span>
                                            </button>
                                            <div class="auto-timer">
                                                <input type="number" id="auto-interval" class="auto-input" value="3.0" min="0.1" max="60.0" step="0.1">
                                                <div class="auto-buttons">
                                                    <button class="auto-up" onclick="adjustInterval(0.1)">▲</button>
                                                    <button class="auto-down" onclick="adjustInterval(-0.1)">▼</button>
                                                </div>
                                                <span class="auto-unit">秒</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="page-info">
                                        <span id="current-page">1</span> / <span id="total-pages">${pages.length}</span>
                                    </div>
                                </div>
                                <div class="right-column">
                                    <h2 class="episode-title">${episodeData.title}</h2>
                                    <div class="page-container">
                                        ${pagesHTML}
                                        <div class="page-navigation">
                                            <button class="nav-button" id="prev-page" onclick="changePage(-1)" disabled>
                                                ‹
                                            </button>
                                            <button class="nav-button" id="next-page" onclick="changePage(1)" ${pages.length <= 1 ? 'disabled' : ''}>
                                                ›
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="episode-navigation">
                                <button class="episode-nav-button" id="prev-episode" onclick="changeEpisode(-1)" ${episode == chapters[currentChapter].episodes[0].num ? 'disabled' : ''}>
                                    ← 前のエピソード
                                </button>
                                <div class="episode-nav-info">
                                    Episode ${episode} / ${maxEpisode}
                                </div>
                                <button class="episode-nav-button" id="next-episode" onclick="changeEpisode(1)" ${episode == maxEpisode ? 'disabled' : ''}>
                                    次のエピソード →
                                </button>
                            </div>
                        `;
                        
                        // グローバル変数にページ情報を保存
                        window.currentPageIndex = 0;
                        window.totalPages = pages.length;
                        
                        // 自動再生を停止
                        if (autoInterval) {
                            toggleAuto();
                        }
                        
                        // 時間設定フィールドのイベントリスナーを設定
                        setTimeout(() => {
                            const intervalInput = document.getElementById('auto-interval');
                            if (intervalInput) {
                                intervalInput.addEventListener('input', function() {
                                    // 自動再生中の場合、新しい間隔で再設定
                                    if (autoInterval) {
                                        toggleAuto(); // 一度停止
                                        setTimeout(() => {
                                            toggleAuto(); // 新しい間隔で再開
                                        }, 100);
                                    }
                                });
                            }
                        }, 100);
                        
                        // 読み込み済みエピソードとして記録
                        loadedEpisodes.add(episode);
                        console.log(`エピソード ${episode} の読み込み完了`);
                        
                    } else {
                        console.log(`エピソード ${episode} のデータが見つかりません`);
                        contentPanel.innerHTML = `
                            <div class="no-content">
                                <img src="../../source/AnotherX/アナザークロス_サムネイル.png" alt="AnotherX サムネイル" class="thumbnail-image">
                                <h2>${title}</h2>
                                <p class="novel-description">このエピソードはnote(日本語)若しくはmedium(英語版)のサイトで公開中です。</p>
                                <div class="external-links-container">
                                    <a href="https://note.com/yuuenchi/n/n8f222e18e395" target="_blank" class="external-link-button">
                                        <span class="link-icon">🇯🇵</span>
                                        <span class="link-text">日本語版（note）</span>
                                    </a>
                                    <a href="https://medium.com/fantasy-novel-anotherx/fantasy-novel-anotherx-f95eb90925bb" target="_blank" class="external-link-button">
                                        <span class="link-icon">🇺🇸</span>
                                        <span class="link-text">英語版（Medium）</span>
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('エピソード読み込みエラー:', error);
                    contentPanel.innerHTML = `
                        <div class="error-content">
                            <h2>${title}</h2>
                            <p>エピソードの読み込みに失敗しました。</p>
                            <button onclick="loadContent('${episode}', '${title}')" class="retry-button">再試行</button>
                        </div>
                    `;
                }
            }

            // ページめくり関数
            window.changePage = function(direction) {
                const pages = document.querySelectorAll('.page');
                const prevButton = document.getElementById('prev-page');
                const nextButton = document.getElementById('next-page');
                const currentPageSpan = document.getElementById('current-page');
                
                if (direction === 1 && window.currentPageIndex < window.totalPages - 1) {
                    // 次のページへ
                    const currentPage = pages[window.currentPageIndex];
                    const nextPage = pages[window.currentPageIndex + 1];
                    
                    // フェードアウト
                    currentPage.classList.remove('active');
                    currentPage.classList.add('prev');
                    
                    // 少し遅延してからフェードイン
                    setTimeout(() => {
                        // すべてのページのprevクラスをクリア
                        pages.forEach(page => page.classList.remove('prev'));
                        nextPage.classList.add('active');
                    }, 100);
                    
                    window.currentPageIndex++;
                } else if (direction === -1 && window.currentPageIndex > 0) {
                    // 前のページへ
                    const currentPage = pages[window.currentPageIndex];
                    const prevPage = pages[window.currentPageIndex - 1];
                    
                    // フェードアウト
                    currentPage.classList.remove('active');
                    currentPage.classList.add('prev');
                    
                    // 少し遅延してからフェードイン
                    setTimeout(() => {
                        // すべてのページのprevクラスをクリア
                        pages.forEach(page => page.classList.remove('prev'));
                        prevPage.classList.add('active');
                    }, 100);
                    
                    window.currentPageIndex--;
                }
                
                // ボタンの状態を更新
                prevButton.disabled = window.currentPageIndex === 0;
                nextButton.disabled = window.currentPageIndex === window.totalPages - 1;
                
                // ページ番号を更新
                currentPageSpan.textContent = window.currentPageIndex + 1;
            };
            
            // エピソード切り替え関数
            window.changeEpisode = async function(direction) {
                const currentEpisode = window.currentEpisode || chapters[currentChapter].episodes[0].num;
                const currentEpisodeIndex = chapters[currentChapter].episodes.findIndex(ep => ep.num === currentEpisode);
                const newEpisodeIndex = currentEpisodeIndex + direction;
                
                if (newEpisodeIndex >= 0 && newEpisodeIndex < chapters[currentChapter].episodes.length) {
                    const newEpisode = chapters[currentChapter].episodes[newEpisodeIndex];
                    
                    // アクティブなエピソードカードを更新
                    episodeCards.forEach(c => c.classList.remove('active'));
                    const targetCard = document.querySelector(`[data-episode="${newEpisode.num}"]`);
                    if (targetCard) {
                        targetCard.classList.add('active');
                    }
                    
                    // 新しいエピソードのコンテンツを読み込み
                    await loadContent(newEpisode.num, newEpisode.title);
                    
                    // グローバル変数を更新
                    window.currentEpisode = newEpisode.num;
                }
            };
            
            // 自動ページめくり機能
            let autoInterval = null;
            
            window.toggleAuto = function() {
                const autoButton = document.getElementById('auto-button');
                const autoIcon = autoButton.querySelector('.auto-icon');
                const autoText = autoButton.querySelector('.auto-text');
                const intervalInput = document.getElementById('auto-interval');
                
                if (autoInterval) {
                    // 自動再生を停止
                    clearInterval(autoInterval);
                    autoInterval = null;
                    autoButton.classList.remove('active');
                    autoIcon.textContent = '▶';
                    autoText.textContent = 'Auto';
                } else {
                    // 自動再生を開始
                    autoButton.classList.add('active');
                    autoIcon.textContent = '⏸';
                    autoText.textContent = 'Stop';
                    
                    // 設定された間隔で自動ページめくり
                    const interval = parseFloat(intervalInput.value) * 1000; // 秒をミリ秒に変換
                    autoInterval = setInterval(() => {
                        // 最後のページでない場合は次のページへ
                        if (window.currentPageIndex < window.totalPages - 1) {
                            changePage(1);
                        } else {
                            // 最後のページの場合は自動再生を停止
                            toggleAuto();
                        }
                    }, interval);
                }
            };
            
            // 時間間隔調整機能
            window.adjustInterval = function(change) {
                const intervalInput = document.getElementById('auto-interval');
                let currentValue = parseFloat(intervalInput.value);
                let newValue = currentValue + change;
                
                // 最小値と最大値を制限
                newValue = Math.max(0.1, Math.min(60.0, newValue));
                
                // 小数点第1位まで表示
                intervalInput.value = newValue.toFixed(1);
                
                // 自動再生中の場合、新しい間隔で再設定
                if (autoInterval) {
                    toggleAuto(); // 一度停止
                    setTimeout(() => {
                        toggleAuto(); // 新しい間隔で再開
                    }, 100);
                }
            };
            
            // 初期化時にエピソード1を自動選択
            renderChapter(0); // 第1章を表示
            const firstEpisodeCard = document.querySelector('.episodes-list .episode-card');
            if (firstEpisodeCard) {
                firstEpisodeCard.classList.add('active');
                const episode = firstEpisodeCard.getAttribute('data-episode');
                const title = firstEpisodeCard.getAttribute('data-title');
                window.currentEpisode = parseInt(episode);
                loadContent(episode, title);
            }

        });
        
        // ライトボックス機能
        function openLightbox(imageSrc, caption) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxCaption = document.getElementById('lightbox-caption');
            
            lightboxImage.src = imageSrc;
            lightboxCaption.textContent = caption;
            lightbox.style.display = 'block';
            
            // ESCキーでライトボックスを閉じる
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeLightbox();
                }
            });
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'none';
        }
    </script>

    <!-- ローディングとエラー表示用のCSS -->
    <style>
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-content {
            text-align: center;
            padding: 2rem;
        }
        
        .retry-button {
            background: linear-gradient(45deg, #4a90e2, #5cb85c);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 1rem;
        }
        
        .retry-button:hover {
            background: linear-gradient(45deg, #5cb85c, #4a90e2);
        }
        
        /* ギャラリーセクション */
        .gallery-section {
            background: linear-gradient(135deg, #F5F5DC 0%, #FDF5E6 50%, #F5F5DC 100%);
            border: 3px solid #8B4513;
            border-radius: 12px;
            margin: 2rem auto;
            max-width: 1300px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .gallery-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            border-radius: 12px 12px 0 0;
        }
        
        .gallery-section h3 {
            text-align: center;
            color: #8B4513;
            font-size: 1.5rem;
            margin: 0 0 1.5rem 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-weight: bold;
            position: relative;
            z-index: 1;
        }
        
        .gallery-section h3::before {
            content: '🖼️';
            margin-right: 0.5rem;
        }
        
        .gallery-description {
            text-align: center;
            color: #8B4513;
            font-size: 1rem;
            margin: 0 0 1.5rem 0;
            font-style: italic;
            opacity: 0.8;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            position: relative;
            z-index: 1;
        }
        
        .gallery-item {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 50%, #8B0000 100%);
            border: 2px solid #654321;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .gallery-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            z-index: 2;
        }
        
        .gallery-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            transition: transform 0.3s ease;
            border-bottom: 2px solid #654321;
        }
        
        .gallery-item:hover img {
            transform: scale(1.02);
        }
        
        .gallery-caption {
            padding: 0.8rem;
            text-align: center;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #D2691E 0%, #FF8C00 50%, #D2691E 100%);
            font-size: 0.9rem;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .gallery-caption::before {
            content: '📖';
            margin-right: 0.3rem;
        }
        
        /* World Map Miruze セクション */
        .world-map-section {
            background: linear-gradient(135deg, #F5F5DC 0%, #FDF5E6 50%, #F5F5DC 100%);
            border: 3px solid #8B4513;
            border-radius: 12px;
            margin: 2rem auto;
            max-width: 1300px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .world-map-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            border-radius: 12px 12px 0 0;
        }
        
        .world-map-section h3 {
            text-align: center;
            color: #8B4513;
            font-size: 1.5rem;
            margin: 0 0 1.5rem 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-weight: bold;
            position: relative;
            z-index: 1;
        }
        
        .world-map-section h3::before {
            content: '🗺️';
            margin-right: 0.5rem;
        }
        
        .world-map-description {
            text-align: center;
            color: #8B4513;
            font-size: 1rem;
            margin: 0 0 1.5rem 0;
            font-style: italic;
            opacity: 0.8;
        }
        
        .world-map-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .world-map-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid #654321;
            transition: transform 0.3s ease;
        }
        
        .world-map-image:hover {
            transform: scale(1.02);
        }
        
        /* タブとローディングスピナーのCSS */
        .tab-content-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin: 20px 0;
            border: 1px solid #f0f0f0;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 16px;
            border: 1px solid #e9ecef;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #6c757d;
            position: relative;
            overflow: hidden;
            min-width: 80px;
            text-align: center;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 123, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .tab-button:hover::before {
            left: 100%;
        }

        .tab-button:hover {
            color: #495057;
            transform: translateY(-1px);
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
            transform: translateY(-1px);
        }

        .tab-button.active::before {
            display: none;
        }
        
        /* ライトボックス */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }
        
        .lightbox-content {
            position: relative;
            margin: auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            transition: color 0.3s ease;
        }
        
        .lightbox-close:hover {
            color: #bbb;
        }
        
        #lightbox-image {
            max-width: 100%;
            max-height: 80%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        #lightbox-caption {
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        /* 外部リンクボタンのスタイル */
        .external-links-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
            align-items: center;
        }
        
        .external-link-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #4a90e2 0%, #5cb85c 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 2px solid transparent;
            min-width: 250px;
            justify-content: center;
        }
        
        .external-link-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #5cb85c 0%, #4a90e2 100%);
            border-color: #FFD700;
        }
        
        .external-link-button .link-icon {
            font-size: 1.2rem;
        }
        
        .external-link-button .link-text {
            font-weight: 600;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .tab-container {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem;
                max-width: 100%;
            }
            
            .tab-button {
                padding: 0.6rem 1rem;
                margin: 0 0.2rem;
                font-size: 0.9rem;
                min-width: 60px;
            }
            
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .gallery-item img {
                height: 120px;
            }
            
            .lightbox-content {
                width: 95%;
                height: 95%;
            }
            
            .lightbox-close {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
            
            .external-link-button {
                min-width: 200px;
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            
            .introduction-section {
                padding: 1.5rem 0;
                margin: 1.5rem 0;
            }
            
            .introduction-section h3 {
                font-size: 1.3rem;
            }
            
            .introduction-content p {
                font-size: 1rem;
            }
        }
        
        /* 紹介文セクションのスタイル */
        .introduction-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 2rem 0;
            margin: 2rem 0;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .introduction-section h3 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .introduction-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .introduction-content p {
            color: #34495e;
            line-height: 1.8;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            text-align: justify;
        }
        
        .introduction-content p:last-child {
            margin-bottom: 0;
        }
    </style>
</body>
</html> 